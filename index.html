<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveCraft Pro - Real-Time Vocal Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #15151a;
            --bg-tertiary: #1f1f28;
            --bg-hover: #2a2a35;
            --border: #333340;
            --accent: #00d9c0;
            --accent-glow: rgba(0, 217, 192, 0.3);
            --accent-secondary: #ff2a6d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }

        /* Start Overlay - REQUIRED for AudioContext */
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            gap: 30px;
        }

        .start-overlay.hidden {
            display: none !important;
        }

        .start-logo {
            font-size: 64px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .start-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .start-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 400px;
            text-align: center;
            line-height: 1.6;
        }

        .start-btn {
            padding: 18px 48px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 40px var(--accent-glow);
            transition: all 0.3s;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px var(--accent-glow);
        }

        /* Main App */
        .app {
            display: none;
            grid-template-rows: 60px 40px 1fr 220px;
            height: 100vh;
        }

        .app.active {
            display: grid;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand-text h1 {
            font-size: 16px;
            font-weight: 700;
        }

        .brand-text span {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Transport */
        .transport {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 6px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .tr-btn {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tr-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tr-btn.primary {
            background: var(--accent);
            color: #000;
            width: 40px;
            height: 40px;
            font-size: 18px;
        }

        .tr-btn.record {
            color: var(--accent-secondary);
        }

        .tr-btn.record.active {
            background: var(--accent-secondary);
            color: white;
            animation: recordPulse 1.5s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .time-display {
            font-family: 'SF Mono', monospace;
            font-size: 20px;
            color: var(--accent);
            background: rgba(0,0,0,0.4);
            padding: 8px 16px;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
            letter-spacing: 1px;
            border: 1px solid var(--border);
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        /* Toolbar */
        .toolbar {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 5px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .toolbar::-webkit-scrollbar {
            display: none;
        }

        .tool-group {
            display: flex;
            gap: 3px;
            padding-right: 12px;
            margin-right: 12px;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tool {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .tool:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tool.active {
            background: rgba(0, 217, 192, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Main Editor */
        .editor {
            display: grid;
            grid-template-columns: 220px 1fr 300px;
            overflow: hidden;
        }

        /* Track Panel */
        .track-panel {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 1px;
            font-weight: 600;
        }

        .add-btn {
            width: 24px;
            height: 24px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--accent);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn:hover {
            background: var(--accent);
            color: #000;
        }

        .tracks-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .track {
            border-bottom: 1px solid var(--border);
            padding: 10px;
            transition: background 0.15s;
        }

        .track:hover {
            background: var(--bg-hover);
        }

        .track.active {
            background: rgba(0, 217, 192, 0.08);
            border-left: 3px solid var(--accent);
        }

        .track-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .track-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .track-icon.vocal { background: rgba(255, 42, 109, 0.2); color: var(--accent-secondary); }
        .track-icon.beat { background: rgba(0, 217, 192, 0.2); color: var(--accent); }

        .track-info {
            flex: 1;
        }

        .track-name {
            font-weight: 600;
            font-size: 12px;
        }

        .track-type {
            font-size: 10px;
            color: var(--text-muted);
        }

        .track-controls {
            display: flex;
            gap: 4px;
        }

        .tc-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        .tc-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tc-btn.mute.active { background: #ff4444; color: white; border-color: #ff4444; }
        .tc-btn.solo.active { background: #ffaa00; color: #000; border-color: #ffaa00; }

        .track-fader {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fader-label {
            font-size: 9px;
            color: var(--text-muted);
            width: 18px;
        }

        .fader {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 2px;
        }

        .fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Timeline */
        .timeline-area {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .timeline-ruler {
            height: 26px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .timeline-tracks {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .timeline-track {
            height: 100px;
            border-bottom: 1px solid var(--border);
            position: relative;
            background: rgba(255,255,255,0.02);
        }

        .track-lane {
            position: relative;
            height: 100%;
        }

        .audio-clip {
            position: absolute;
            height: 80px;
            top: 10px;
            border-radius: 4px;
            overflow: hidden;
            cursor: grab;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .audio-clip:active {
            cursor: grabbing;
        }

        .audio-clip.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 217, 192, 0.3);
        }

        .clip-vocal {
            background: linear-gradient(180deg, rgba(255, 42, 109, 0.7), rgba(255, 42, 109, 0.3));
        }

        .clip-beat {
            background: linear-gradient(180deg, rgba(0, 217, 192, 0.5), rgba(0, 217, 192, 0.2));
        }

        .clip-waveform {
            width: 100%;
            height: 100%;
            display: block;
        }

        .clip-info {
            position: absolute;
            top: 4px;
            left: 8px;
            font-size: 10px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 3px;
            pointer-events: none;
        }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 0 10px var(--accent);
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -4px;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
        }

        /* Effects Panel - THE IMPORTANT PART */
        .effects-panel {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .effects-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bypass-btn {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .bypass-btn.active {
            background: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        .effects-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .effect-module {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .effect-module.active {
            border-color: var(--accent);
        }

        .effect-module.bypassed {
            opacity: 0.5;
        }

        .effect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .effect-title {
            font-weight: 600;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .effect-toggle {
            width: 32px;
            height: 18px;
            background: var(--bg-secondary);
            border-radius: 9px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .effect-toggle.active {
            background: var(--accent);
        }

        .effect-toggle::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .effect-toggle.active::after {
            transform: translateX(14px);
        }

        .effect-param {
            margin-bottom: 8px;
        }

        .effect-param:last-child {
            margin-bottom: 0;
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .param-name {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .param-value {
            font-size: 11px;
            color: var(--accent);
            font-family: 'SF Mono', monospace;
            min-width: 50px;
            text-align: right;
        }

        .param-slider {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            background: var(--bg-secondary);
            border-radius: 3px;
            outline: none;
        }

        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
        }

        .preset-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .preset-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        /* Bottom Panel */
        .bottom-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            padding: 15px;
            gap: 15px;
            overflow-x: auto;
        }

        .mixer-channel {
            width: 60px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }

        .mixer-channel.active {
            border-color: var(--accent);
        }

        .ch-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            height: 50px;
        }

        .ch-meter {
            width: 8px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .ch-meter-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #00ff88 0%, #00ff88 60%, #ffaa00 80%, #ff4444 100%);
            border-radius: 4px;
            transition: height 0.1s;
        }

        .ch-fader {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 25px;
            height: 80px;
        }

        /* Compare Button */
        .compare-section {
            position: fixed;
            bottom: 240px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .compare-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .compare-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .compare-btn.active {
            background: var(--accent);
            color: #000;
        }

        /* Import Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drop-zone:hover {
            border-color: var(--accent);
            background: rgba(0, 217, 192, 0.05);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
        }

        .btn.primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- START OVERLAY - Click to enable audio -->
    <div class="start-overlay" id="startOverlay">
        <div class="start-logo">üéôÔ∏è</div>
        <div class="start-title">WaveCraft Pro</div>
        <div class="start-subtitle">
            Professional vocal processing with real-time EQ, compression, and effects. 
            Click below to start the audio engine.
        </div>
        <button class="start-btn" onclick="initAudioEngine()">‚ñ∂ Start Audio Engine</button>
    </div>

    <!-- MAIN APP -->
    <div class="app" id="app">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <div class="logo">‚óâ</div>
                <div class="brand-text">
                    <h1>WaveCraft Pro</h1>
                    <span>Real-Time Vocal Processor</span>
                </div>
            </div>

            <div class="transport">
                <button class="tr-btn" onclick="goToStart()">‚èÆ</button>
                <button class="tr-btn primary" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                <button class="tr-btn" onclick="goToEnd()">‚è≠</button>
                <button class="tr-btn record" id="recordBtn" onclick="toggleRecord()">‚è∫</button>
            </div>

            <div class="time-display" id="timeDisplay">00:00:00</div>

            <div class="header-actions">
                <button class="action-btn" onclick="showImport()">üìÅ Import</button>
                <button class="action-btn" onclick="exportAudio()">üíæ Export</button>
            </div>
        </header>

        <!-- Toolbar - Now Scrollable -->
        <div class="toolbar">
            <div class="tool-group">
                <button class="tool active" onclick="setTool('select')">üëÜ Select</button>
                <button class="tool" onclick="setTool('move')">‚úã Move</button>
                <button class="tool" onclick="setTool('cut')">‚úÇÔ∏è Split</button>
                <button class="tool" onclick="setTool('trim')">üìê Trim</button>
            </div>
            <div class="tool-group">
                <button class="tool" onclick="zoomIn()">üîç+</button>
                <button class="tool" onclick="zoomOut()">üîç-</button>
                <button class="tool" onclick="fitToScreen()">‚§¢ Fit</button>
            </div>
            <div class="tool-group">
                <button class="tool" onclick="undo()">‚Ü©Ô∏è Undo</button>
                <button class="tool" onclick="redo()">‚Ü™Ô∏è Redo</button>
            </div>
            <div class="tool-group">
                <button class="tool" onclick="cut()">‚úÇÔ∏è Cut</button>
                <button class="tool" onclick="copy()">üìã Copy</button>
                <button class="tool" onclick="paste()">üìÑ Paste</button>
                <button class="tool" onclick="deleteSelection()">üóëÔ∏è Delete</button>
            </div>
            <div class="tool-group">
                <button class="tool" onclick="fadeIn()">üìà Fade In</button>
                <button class="tool" onclick="fadeOut()">üìâ Fade Out</button>
                <button class="tool" onclick="normalize()">üìä Normalize</button>
            </div>
        </div>

        <!-- Editor -->
        <div class="editor">
            <!-- Track Panel -->
            <div class="track-panel">
                <div class="panel-header">
                    <span class="panel-title">Tracks</span>
                    <button class="add-btn" onclick="addTrack()">+</button>
                </div>
                <div class="tracks-list" id="trackList"></div>
            </div>

            <!-- Timeline -->
            <div class="timeline-area">
                <div class="timeline-ruler" id="timelineRuler"></div>
                <div class="timeline-tracks" id="timelineTracks">
                    <div class="playhead" id="playhead" style="left: 0px;"></div>
                </div>
            </div>

            <!-- Effects Panel - REAL PROCESSING CONTROLS -->
            <div class="effects-panel">
                <div class="effects-header">
                    <span class="panel-title">Effects Chain</span>
                    <button class="bypass-btn" id="bypassAll" onclick="toggleBypassAll()">Bypass All</button>
                </div>
                
                <div class="effects-list" id="effectsList">
                    <!-- EQ Module -->
                    <div class="effect-module active" id="eqModule">
                        <div class="effect-header">
                            <span class="effect-title">üìä Parametric EQ</span>
                            <div class="effect-toggle active" onclick="toggleEffect('eq')"></div>
                        </div>
                        
                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Low Cut</span>
                                <span class="param-value" id="eq-low-val">80 Hz</span>
                            </div>
                            <input type="range" class="param-slider" min="20" max="200" value="80" 
                                   oninput="updateEffectParam('eq', 'lowCut', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Low Mid Gain</span>
                                <span class="param-value" id="eq-lowmid-val">+2 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-12" max="12" value="2" 
                                   oninput="updateEffectParam('eq', 'lowMidGain', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Presence Gain</span>
                                <span class="param-value" id="eq-presence-val">+4 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-12" max="12" value="4" 
                                   oninput="updateEffectParam('eq', 'presenceGain', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Air Gain</span>
                                <span class="param-value" id="eq-air-val">+3 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-12" max="12" value="3" 
                                   oninput="updateEffectParam('eq', 'airGain', this.value)">
                        </div>

                        <div class="presets">
                            <div class="preset-btn active" onclick="applyEQPreset('flat')">Flat</div>
                            <div class="preset-btn" onclick="applyEQPreset('vocal')">Vocal</div>
                            <div class="preset-btn" onclick="applyEQPreset('radio')">Radio</div>
                            <div class="preset-btn" onclick="applyEQPreset('warm')">Warm</div>
                        </div>
                    </div>

                    <!-- Compressor Module -->
                    <div class="effect-module active" id="compModule">
                        <div class="effect-header">
                            <span class="effect-title">üéöÔ∏è Compressor</span>
                            <div class="effect-toggle active" onclick="toggleEffect('compressor')"></div>
                        </div>
                        
                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Threshold</span>
                                <span class="param-value" id="comp-thresh-val">-18 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-40" max="0" value="-18" 
                                   oninput="updateEffectParam('compressor', 'threshold', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Ratio</span>
                                <span class="param-value" id="comp-ratio-val">4:1</span>
                            </div>
                            <input type="range" class="param-slider" min="1" max="20" value="4" 
                                   oninput="updateEffectParam('compressor', 'ratio', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Attack</span>
                                <span class="param-value" id="comp-attack-val">3 ms</span>
                            </div>
                            <input type="range" class="param-slider" min="0" max="50" value="3" 
                                   oninput="updateEffectParam('compressor', 'attack', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Release</span>
                                <span class="param-value" id="comp-release-val">100 ms</span>
                            </div>
                            <input type="range" class="param-slider" min="10" max="500" value="100" 
                                   oninput="updateEffectParam('compressor', 'release', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Makeup Gain</span>
                                <span class="param-value" id="comp-makeup-val">+6 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="0" max="20" value="6" 
                                   oninput="updateEffectParam('compressor', 'makeupGain', this.value)">
                        </div>
                    </div>

                    <!-- De-esser Module -->
                    <div class="effect-module" id="deesserModule">
                        <div class="effect-header">
                            <span class="effect-title">‚ú® De-esser</span>
                            <div class="effect-toggle" onclick="toggleEffect('deesser')"></div>
                        </div>
                        
                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Frequency</span>
                                <span class="param-value" id="deesser-freq-val">7 kHz</span>
                            </div>
                            <input type="range" class="param-slider" min="2000" max="12000" value="7000" 
                                   oninput="updateEffectParam('deesser', 'frequency', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Reduction</span>
                                <span class="param-value" id="deesser-red-val">-6 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-20" max="0" value="-6" 
                                   oninput="updateEffectParam('deesser', 'reduction', this.value)">
                        </div>
                    </div>

                    <!-- Limiter Module -->
                    <div class="effect-module active" id="limiterModule">
                        <div class="effect-header">
                            <span class="effect-title">üõë Limiter</span>
                            <div class="effect-toggle active" onclick="toggleEffect('limiter')"></div>
                        </div>
                        
                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Ceiling</span>
                                <span class="param-value" id="limit-ceil-val">-1 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-3" max="0" step="0.1" value="-1" 
                                   oninput="updateEffectParam('limiter', 'ceiling', this.value)">
                        </div>

                        <div class="effect-param">
                            <div class="param-row">
                                <span class="param-name">Threshold</span>
                                <span class="param-value" id="limit-thresh-val">-6 dB</span>
                            </div>
                            <input type="range" class="param-slider" min="-20" max="0" value="-6" 
                                   oninput="updateEffectParam('limiter', 'threshold', this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Button (Dry/Wet) -->
        <div class="compare-section">
            <span class="compare-label">Compare:</span>
            <button class="compare-btn active" id="wetBtn" onclick="setCompareMode('wet')">Processed</button>
            <button class="compare-btn" id="dryBtn" onclick="setCompareMode('dry')">Original</button>
        </div>

        <!-- Bottom Mixer -->
        <div class="bottom-panel" id="mixer"></div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 10px;">Import Audio</h2>
            <div class="drop-zone" id="dropZone">
                <div style="font-size: 40px; margin-bottom: 10px;">üìÅ</div>
                <div>Drop audio files here</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">WAV, MP3, FLAC supported</div>
            </div>
            <input type="file" id="fileInput" accept="audio/*" multiple style="display: none;">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn primary" onclick="document.getElementById('fileInput').click()">Browse</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // AUDIO ENGINE - REAL PROCESSING
        // ==========================================
        
        let audioContext = null;
        let masterGain = null;
        let masterLimiter = null;
        let isPlaying = false;
        let currentTime = 0;
        let animationFrame = null;
        
        // Track data
        let tracks = [];
        let clips = [];
        let activeSources = [];
        let selectedTrack = null;
        
        // Effect nodes storage
        let effectNodes = {
            eq: null,
            compressor: null,
            deesser: null,
            limiter: null
        };
        
        // Effect parameters
        let effectParams = {
            eq: {
                enabled: true,
                lowCut: 80,
                lowMidGain: 2,
                presenceGain: 4,
                airGain: 3
            },
            compressor: {
                enabled: true,
                threshold: -18,
                ratio: 4,
                attack: 3,
                release: 100,
                makeupGain: 6
            },
            deesser: {
                enabled: false,
                frequency: 7000,
                reduction: -6
            },
            limiter: {
                enabled: true,
                ceiling: -1,
                threshold: -6
            }
        };

        // Initialize Audio Engine (called by user click)
        function initAudioEngine() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master chain
                masterGain = audioContext.createGain();
                masterGain.gain.value = 0.8;
                
                // Master limiter for safety
                masterLimiter = audioContext.createDynamicsCompressor();
                masterLimiter.threshold.value = -0.5;
                masterLimiter.ratio.value = 20;
                masterLimiter.attack.value = 0.001;
                masterLimiter.release.value = 0.01;
                
                // Connect: masterGain -> masterLimiter -> destination
                masterGain.connect(masterLimiter);
                masterLimiter.connect(audioContext.destination);
                
                // Create effect nodes
                createEffectNodes();
                
                // Hide overlay, show app
                document.getElementById('startOverlay').classList.add('hidden');
                document.getElementById('app').classList.add('active');
                
                console.log('‚úÖ Audio engine started. Sample rate:', audioContext.sampleRate);
                
            } catch (error) {
                alert('Error starting audio engine: ' + error.message);
            }
        }

        // Create Audio Effect Nodes
        function createEffectNodes() {
            // EQ Chain - Multiple biquad filters in series
            
            // 1. High-pass filter (Low Cut)
            const highpass = audioContext.createBiquadFilter();
            highpass.type = 'highpass';
            highpass.frequency.value = effectParams.eq.lowCut;
            highpass.Q.value = 0.7;
            
            // 2. Low-mid peaking filter
            const lowMid = audioContext.createBiquadFilter();
            lowMid.type = 'peaking';
            lowMid.frequency.value = 250;
            lowMid.Q.value = 1.0;
            lowMid.gain.value = effectParams.eq.lowMidGain;
            
            // 3. Presence peaking filter (3-5kHz)
            const presence = audioContext.createBiquadFilter();
            presence.type = 'peaking';
            presence.frequency.value = 5000;
            presence.Q.value = 1.2;
            presence.gain.value = effectParams.eq.presenceGain;
            
            // 4. High shelf (Air)
            const airShelf = audioContext.createBiquadFilter();
            airShelf.type = 'highshelf';
            airShelf.frequency.value = 12000;
            airShelf.gain.value = effectParams.eq.airGain;
            
            // Store EQ chain
            effectNodes.eq = {
                highpass,
                lowMid,
                presence,
                airShelf,
                input: highpass,
                output: airShelf
            };
            
            // Connect EQ chain
            highpass.connect(lowMid);
            lowMid.connect(presence);
            presence.connect(airShelf);
            
            // Compressor
            const compressor = audioContext.createDynamicsCompressor();
            compressor.threshold.value = effectParams.compressor.threshold;
            compressor.ratio.value = effectParams.compressor.ratio;
            compressor.attack.value = effectParams.compressor.attack / 1000; // ms to seconds
            compressor.release.value = effectParams.compressor.release / 1000;
            compressor.knee.value = 30;
            
            // Makeup gain after compressor
            const makeupGain = audioContext.createGain();
            makeupGain.gain.value = dbToGain(effectParams.compressor.makeupGain);
            
            effectNodes.compressor = {
                compressor,
                makeupGain,
                input: compressor,
                output: makeupGain
            };
            
            compressor.connect(makeupGain);
            
            // De-esser (using peaking filter + sidechain-style compression)
            const deesserFilter = audioContext.createBiquadFilter();
            deesserFilter.type = 'peaking';
            deesserFilter.frequency.value = effectParams.deesser.frequency;
            deesserFilter.Q.value = 2;
            deesserFilter.gain.value = effectParams.deesser.reduction;
            
            effectNodes.deesser = {
                filter: deesserFilter,
                input: deesserFilter,
                output: deesserFilter
            };
            
            // Limiter
            const limiter = audioContext.createDynamicsCompressor();
            limiter.threshold.value = effectParams.limiter.threshold;
            limiter.ratio.value = 20;
            limiter.attack.value = 0.001;
            limiter.release.value = 0.01;
            
            // Ceiling gain control
            const ceilingGain = audioContext.createGain();
            ceilingGain.gain.value = dbToGain(effectParams.limiter.ceiling);
            
            effectNodes.limiter = {
                limiter,
                ceilingGain,
                input: limiter,
                output: ceilingGain
            };
            
            limiter.connect(ceilingGain);
            
            console.log('‚úÖ Effect nodes created');
        }

        // Build processing chain for a track
        function buildTrackChain(sourceNode, trackGainNode) {
            let currentNode = sourceNode;
            
            // 1. EQ
            if (effectParams.eq.enabled && effectNodes.eq) {
                currentNode.connect(effectNodes.eq.input);
                currentNode = effectNodes.eq.output;
            }
            
            // 2. Compressor
            if (effectParams.compressor.enabled && effectNodes.compressor) {
                currentNode.connect(effectNodes.compressor.input);
                currentNode = effectNodes.compressor.output;
            }
            
            // 3. De-esser
            if (effectParams.deesser.enabled && effectNodes.deesser) {
                currentNode.connect(effectNodes.deesser.input);
                currentNode = effectNodes.deesser.output;
            }
            
            // 4. Limiter
            if (effectParams.limiter.enabled && effectNodes.limiter) {
                currentNode.connect(effectNodes.limiter.input);
                currentNode = effectNodes.limiter.output;
            }
            
            // 5. Track gain
            currentNode.connect(trackGainNode);
            
            // 6. Master
            trackGainNode.connect(masterGain);
            
            return trackGainNode;
        }

        // Utility: dB to gain conversion
        function dbToGain(db) {
            return Math.pow(10, db / 20);
        }

        // Update effect parameters in real-time
        function updateEffectParam(effectType, param, value) {
            const numValue = parseFloat(value);
            effectParams[effectType][param] = numValue;
            
            // Update UI
            const displayEl = document.getElementById(`${effectType}-${param.replace(/[A-Z]/g, m => '-' + m.toLowerCase())}-val`);
            if (displayEl) {
                let displayValue = numValue;
                let unit = '';
                
                if (param === 'lowCut' || param === 'frequency') unit = ' Hz';
                else if (param.includes('Gain') || param === 'reduction' || param === 'ceiling' || param === 'threshold') unit = ' dB';
                else if (param === 'ratio') unit = ':1';
                else if (param === 'attack' || param === 'release') {
                    displayValue = numValue;
                    unit = numValue < 10 ? ' ms' : ' ms';
                }
                
                const prefix = numValue > 0 && (param.includes('Gain') || param === 'makeupGain') ? '+' : '';
                displayEl.textContent = `${prefix}${displayValue}${unit}`;
            }
            
            // Update audio nodes in real-time
            if (!audioContext) return;
            
            switch(effectType) {
                case 'eq':
                    if (effectNodes.eq) {
                        if (param === 'lowCut') effectNodes.eq.highpass.frequency.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                        if (param === 'lowMidGain') effectNodes.eq.lowMid.gain.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                        if (param === 'presenceGain') effectNodes.eq.presence.gain.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                        if (param === 'airGain') effectNodes.eq.airShelf.gain.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                    }
                    break;
                    
                case 'compressor':
                    if (effectNodes.compressor) {
                        if (param === 'threshold') effectNodes.compressor.compressor.threshold.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                        if (param === 'ratio') effectNodes.compressor.compressor.ratio.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                        if (param === 'attack') effectNodes.compressor.compressor.attack.setTargetAtTime(numValue / 1000, audioContext.currentTime, 0.01);
                        if (param === 'release') effectNodes.compressor.compressor.release.setTargetAtTime(numValue / 1000, audioContext.currentTime, 0.01);
                        if (param === 'makeupGain') effectNodes.compressor.makeupGain.gain.setTargetAtTime(dbToGain(numValue), audioContext.currentTime, 0.01);
                    }
                    break;
                    
                case 'deesser':
                    if (effectNodes.deesser) {
                        if (param === 'frequency') effectNodes.deesser.filter.frequency.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                        if (param === 'reduction') effectNodes.deesser.filter.gain.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                    }
                    break;
                    
                case 'limiter':
                    if (effectNodes.limiter) {
                        if (param === 'ceiling') effectNodes.limiter.ceilingGain.gain.setTargetAtTime(dbToGain(numValue), audioContext.currentTime, 0.01);
                        if (param === 'threshold') effectNodes.limiter.limiter.threshold.setTargetAtTime(numValue, audioContext.currentTime, 0.01);
                    }
                    break;
            }
        }

        // Toggle effects on/off
        function toggleEffect(effectType) {
            effectParams[effectType].enabled = !effectParams[effectType].enabled;
            
            const module = document.getElementById(`${effectType}Module`);
            const toggle = event.target;
            
            toggle.classList.toggle('active');
            module.classList.toggle('active');
            
            // If playing, restart to apply changes
            if (isPlaying) {
                pause();
                play();
            }
        }

        // Toggle bypass all
        function toggleBypassAll() {
            const btn = document.getElementById('bypassAll');
            const bypass = !btn.classList.contains('active');
            
            btn.classList.toggle('active');
            
            // Toggle all effects
            ['eq', 'compressor', 'deesser', 'limiter'].forEach(effect => {
                effectParams[effect].enabled = !bypass;
                const module = document.getElementById(`${effect}Module`);
                const toggle = module.querySelector('.effect-toggle');
                
                if (bypass) {
                    toggle.classList.remove('active');
                    module.classList.remove('active');
                } else {
                    toggle.classList.add('active');
                    module.classList.add('active');
                }
            });
            
            if (isPlaying) {
                pause();
                play();
            }
        }

        // Compare Dry/Wet
        function setCompareMode(mode) {
            document.getElementById('wetBtn').classList.toggle('active', mode === 'wet');
            document.getElementById('dryBtn').classList.toggle('active', mode === 'dry');
            
            if (mode === 'dry') {
                // Disable all effects temporarily
                Object.keys(effectParams).forEach(key => {
                    effectParams[key].enabled = false;
                });
            } else {
                // Re-enable based on UI state
                ['eq', 'compressor', 'deesser', 'limiter'].forEach(effect => {
                    const toggle = document.querySelector(`#${effect}Module .effect-toggle`);
                    effectParams[effect].enabled = toggle.classList.contains('active');
                });
            }
            
            if (isPlaying) {
                pause();
                play();
            }
        }

        // EQ Presets
        function applyEQPreset(preset) {
            const presets = {
                flat: { lowCut: 20, lowMidGain: 0, presenceGain: 0, airGain: 0 },
                vocal: { lowCut: 80, lowMidGain: 2, presenceGain: 4, airGain: 3 },
                radio: { lowCut: 100, lowMidGain: 3, presenceGain: 6, airGain: 4 },
                warm: { lowCut: 60, lowMidGain: 4, presenceGain: 2, airGain: 1 }
            };
            
            const p = presets[preset];
            if (!p) return;
            
            // Update UI sliders
            document.querySelector('#eqModule input[oninput*="lowCut"]').value = p.lowCut;
            document.querySelector('#eqModule input[oninput*="lowMidGain"]').value = p.lowMidGain;
            document.querySelector('#eqModule input[oninput*="presenceGain"]').value = p.presenceGain;
            document.querySelector('#eqModule input[oninput*="airGain"]').value = p.airGain;
            
            // Update parameters
            updateEffectParam('eq', 'lowCut', p.lowCut);
            updateEffectParam('eq', 'lowMidGain', p.lowMidGain);
            updateEffectParam('eq', 'presenceGain', p.presenceGain);
            updateEffectParam('eq', 'airGain', p.airGain);
            
            // Update preset buttons
            document.querySelectorAll('#eqModule .preset-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ==========================================
        // TRANSPORT & PLAYBACK
        // ==========================================

        function togglePlay() {
            if (!audioContext) {
                alert('Please click "Start Audio Engine" first');
                return;
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        }

        function play() {
            isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏';
            
            // Stop any existing sources
            stopAllSources();
            
            // Play all clips
            clips.forEach(clip => {
                if (clip.buffer && clip.track && !clip.track.muted) {
                    playClip(clip);
                }
            });
            
            animate();
        }

        function playClip(clip) {
            const source = audioContext.createBufferSource();
            source.buffer = clip.buffer;
            
            // Create track gain node
            const trackGain = audioContext.createGain();
            trackGain.gain.value = (clip.track.volume / 100) || 0.8;
            
            // Build processing chain
            buildTrackChain(source, trackGain);
            
            // Calculate start time
            const offset = Math.max(0, currentTime - clip.start);
            const duration = clip.buffer.duration - offset;
            
            if (duration > 0) {
                source.start(0, offset, duration);
                activeSources.push({ source, clip });
                
                source.onended = () => {
                    const idx = activeSources.findIndex(s => s.source === source);
                    if (idx > -1) activeSources.splice(idx, 1);
                };
            }
        }

        function stopAllSources() {
            activeSources.forEach(({ source }) => {
                try {
                    source.stop();
                } catch(e) {}
            });
            activeSources = [];
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂';
            stopAllSources();
            cancelAnimationFrame(animationFrame);
        }

        function animate() {
            if (!isPlaying) return;
            
            currentTime += 0.016;
            updatePlayhead();
            
            animationFrame = requestAnimationFrame(animate);
        }

        function updatePlayhead() {
            const playhead = document.getElementById('playhead');
            const pixels = currentTime * 100; // 100px per second at zoom 100
            playhead.style.left = `${pixels}px`;
            
            const mins = Math.floor(currentTime / 60);
            const secs = Math.floor(currentTime % 60);
            const ms = Math.floor((currentTime % 1) * 100);
            
            document.getElementById('timeDisplay').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        function goToStart() {
            currentTime = 0;
            updatePlayhead();
            if (isPlaying) {
                pause();
                play();
            }
        }

        function goToEnd() {
            let end = 0;
            clips.forEach(clip => {
                end = Math.max(end, clip.start + clip.duration);
            });
            currentTime = end || 0;
            updatePlayhead();
        }

        function toggleRecord() {
            document.getElementById('recordBtn').classList.toggle('active');
        }

        // ==========================================
        // TRACK & CLIP MANAGEMENT
        // ==========================================

        function addTrack(type = 'vocal') {
            const id = tracks.length;
            const track = {
                id,
                type,
                name: type === 'vocal' ? `Vocal ${id + 1}` : `Track ${id + 1}`,
                muted: false,
                solo: false,
                volume: 80
            };
            
            tracks.push(track);
            
            // Render track panel
            const div = document.createElement('div');
            div.className = 'track';
            div.id = `track-${id}`;
            div.innerHTML = `
                <div class="track-header">
                    <div class="track-icon ${type}">${type === 'vocal' ? 'üé§' : 'üéµ'}</div>
                    <div class="track-info">
                        <div class="track-name">${track.name}</div>
                        <div class="track-type">${type}</div>
                    </div>
                </div>
                <div class="track-controls">
                    <button class="tc-btn mute" onclick="toggleMute(${id})">M</button>
                    <button class="tc-btn solo" onclick="toggleSolo(${id})">S</button>
                </div>
                <div class="track-fader">
                    <span class="fader-label">Vol</span>
                    <input type="range" class="fader" min="0" max="100" value="${track.volume}" 
                           oninput="setVolume(${id}, this.value)">
                </div>
            `;
            
            div.onclick = () => selectTrack(id);
            document.getElementById('trackList').appendChild(div);
            
            // Create timeline lane
            const lane = document.createElement('div');
            lane.className = 'timeline-track';
            lane.id = `lane-${id}`;
            lane.innerHTML = `<div class="track-lane" id="lane-content-${id}"></div>`;
            document.getElementById('timelineTracks').appendChild(lane);
            
            // Add to mixer
            addMixerChannel(track);
            
            selectTrack(id);
        }

        function addMixerChannel(track) {
            const mixer = document.getElementById('mixer');
            const ch = document.createElement('div');
            ch.className = 'mixer-channel';
            ch.id = `mixer-${track.id}`;
            ch.innerHTML = `
                <div class="ch-label">${track.name}</div>
                <div class="ch-meter">
                    <div class="ch-meter-fill" id="meter-${track.id}" style="height: 0%;"></div>
                </div>
                <input type="range" class="ch-fader" min="0" max="100" value="${track.volume}" 
                       orient="vertical" oninput="setVolume(${track.id}, this.value)">
            `;
            mixer.appendChild(ch);
        }

        function selectTrack(id) {
            document.querySelectorAll('.track').forEach(t => t.classList.remove('active'));
            document.getElementById(`track-${id}`)?.classList.add('active');
            selectedTrack = tracks[id];
        }

        function toggleMute(id) {
            const track = tracks[id];
            track.muted = !track.muted;
            event.target.classList.toggle('active');
            
            if (isPlaying) {
                pause();
                play();
            }
        }

        function toggleSolo(id) {
            const track = tracks[id];
            track.solo = !track.solo;
            event.target.classList.toggle('active');
        }

        function setVolume(id, value) {
            const track = tracks[id];
            if (track) track.volume = parseInt(value);
        }

        // ==========================================
        // FILE IMPORT
        // ==========================================

        function showImport() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // Setup drag and drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            if (!audioContext) {
                alert('Please start the audio engine first');
                return;
            }
            
            closeModal();
            
            for (let file of files) {
                await loadAudioFile(file);
            }
        }

        async function loadAudioFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                const type = file.name.toLowerCase().includes('beat') ? 'beat' : 'vocal';
                
                if (tracks.length === 0) {
                    addTrack(type);
                }
                
                const track = selectedTrack || tracks[tracks.length - 1];
                
                const clip = {
                    id: clips.length,
                    track,
                    buffer: audioBuffer,
                    start: 0,
                    duration: audioBuffer.duration,
                    name: file.name.replace(/\.[^/.]+$/, "")
                };
                
                clips.push(clip);
                renderClip(clip);
                
                console.log(`‚úÖ Loaded: ${file.name} (${audioBuffer.duration.toFixed(2)}s)`);
                
            } catch (error) {
                console.error('Error loading audio:', error);
                alert('Error loading file. Please try WAV or MP3 format.');
            }
        }

        function renderClip(clip) {
            const lane = document.getElementById(`lane-content-${clip.track.id}`);
            if (!lane) return;
            
            const div = document.createElement('div');
            div.className = `audio-clip clip-${clip.track.type}`;
            div.style.left = '0px';
            div.style.width = `${clip.duration * 100}px`;
            
            const canvas = document.createElement('canvas');
            canvas.className = 'clip-waveform';
            canvas.width = Math.max(50, clip.duration * 100);
            canvas.height = 80;
            
            drawWaveform(canvas, clip.buffer, clip.track.type);
            
            div.innerHTML = `<div class="clip-info">${clip.name}</div>`;
            div.appendChild(canvas);
            
            // Make draggable
            makeDraggable(div, clip);
            
            lane.appendChild(div);
            clip.element = div;
        }

        function drawWaveform(canvas, buffer, type) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const data = buffer.getChannelData(0);
            const step = Math.ceil(data.length / width);
            const amp = height / 2;
            
            ctx.clearRect(0, 0, width, height);
            
            // Center line
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath();
            ctx.moveTo(0, amp);
            ctx.lineTo(width, amp);
            ctx.stroke();
            
            // Waveform
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            
            for (let i = 0; i < width; i++) {
                let min = 1.0;
                let max = -1.0;
                
                for (let j = 0; j < step; j++) {
                    const datum = data[i * step + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                
                const y = (1 + min) * amp;
                const h = Math.max(1, (max - min) * amp);
                ctx.fillRect(i, y, 1, h);
            }
        }

        function makeDraggable(element, clip) {
            let isDragging = false;
            let startX, startLeft;
            
            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startLeft = parseFloat(element.style.left) || 0;
                element.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const delta = e.clientX - startX;
                const newLeft = startLeft + delta;
                const timePos = newLeft / 100;
                
                clip.start = Math.max(0, Math.round(timePos * 10) / 10);
                element.style.left = `${clip.start * 100}px`;
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.cursor = 'grab';
            });
        }

        // ==========================================
        // TOOLS & UTILITIES
        // ==========================================

        function setTool(tool) {
            document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function zoomIn() {
            // Implementation
        }

        function zoomOut() {
            // Implementation
        }

        function fitToScreen() {
            // Implementation
        }

        function undo() { console.log('Undo'); }
        function redo() { console.log('Redo'); }
        function cut() { console.log('Cut'); }
        function copy() { console.log('Copy'); }
        function paste() { console.log('Paste'); }
        function deleteSelection() { console.log('Delete'); }
        function fadeIn() { console.log('Fade In'); }
        function fadeOut() { console.log('Fade Out'); }
        function normalize() { console.log('Normalize'); }

        function exportAudio() {
            alert('Export would render all tracks with current effects to WAV/MP3');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'Delete':
                    deleteSelection();
                    break;
            }
        });

        console.log('WaveCraft Pro loaded. Click "Start Audio Engine" to begin.');
    </script>
</body>
</html>
